<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mission Board</title>
  <link rel="stylesheet" href="./CSS/bountyboard.css" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />
</head>
<body>
<header class="navbar">
  <div class="navbar-left">
    <a href="index.html" class="logo">VORTEX MISSIONS</a>
    <nav>
      <ul>
        <li><a href="index.html">HOME</a></li>
        <li><a href="#">INDUSTRIAL</a></li>
        <li><a href="#">LOGISTICS</a></li>
        <li><a href="#">SCIENCE</a></li>
        <li><a href="#">DEFENSE</a></li>
      </ul>
    </nav>
  </div>
  <div class="navbar-right">
    <a href="https://discord.gg/DuWnazV4" class="icon-link"><img src="./Images/Discord.png" alt="Discord Icon"><span>DISCORD</span></a>
    <a href="#" class="icon-link"><img src="./Images/Youtube.png" alt="YouTube Icon"><span>YOUTUBE</span></a>
    <a href="https://www.twitch.tv/flockersdesign" class="icon-link"><img src="./Images/Twitch.png" alt="Twitch Icon"><span>TWITCH</span></a>
  </div>
</header>

<section class="player-setup-section" id="player-setup-section-wrapper">
  <div id="player-setup" class="setup-container">
    <h2 class="setup-title">IDENTIFY YOURSELF, PILOT (IN-GAME NAME)</h2>
    <div class="input-group">
      <input type="text" id="playerNameInput" placeholder="Enter your In-Game Name..." class="styled-input" />
      <button id="savePlayer" class="styled-button">Secure Access</button>
    </div>
  </div>
</section>

<section id="mission-section" style="display:none; padding:20px;">
  <h2 class="section-protocol-title">AVAILABLE MISSIONS</h2>

  <label for="missionTypeFilter">Filter by Mission Type:</label>
  <select id="missionTypeFilter" class="styled-input">
    <option value="all">All</option>
    <option value="bounty">Bounty</option>
    <option value="mining">Mining</option>
    <option value="salvage">Salvage</option>
    <option value="exploration">Exploration</option>
    <option value="resource">Resource Gathering</option>
  </select>

  <!-- Example mission cards -->
  <div class="large-content-card" data-mission-type="bounty">
    <div class="card-header-icon">
      <img src="./Images/Patches/Salvage-recovery.png" alt="Mission Icon" class="card-large-icon" />
      <h2>Starfire_X</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 50.000 UEC</p>
      <p class="card-main-text">Caught raiding supply routes. Last seen near Port Olisar.</p>
      <button class="accept-mission styled-button" data-mission="Starfire_X">Accept Mission</button>
    </div>
  </div>

  <div class="large-content-card" data-mission-type="mining">
    <div class="card-header-icon">
      <img src="./Images/Patches/Mining-Operation.png" alt="Mining Icon" class="card-large-icon" />
      <h2>Asteroid Survey</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 25.000 UEC</p>
      <p class="card-main-text">Collect minerals from the Yela asteroid belt.</p>
      <button class="accept-mission styled-button" data-mission="Asteroid Survey">Accept Mission</button>
    </div>
  </div>

  <div class="large-content-card" data-mission-type="salvage">
    <div class="card-header-icon">
      <img src="./Images/Patches/Salvage-recovery.png" alt="Salvage Icon" class="card-large-icon" />
      <h2>Derelict Wreck</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 40.000 UEC</p>
      <p class="card-main-text">Recover valuable items from a derelict ship near Hurston.</p>
      <button class="accept-mission styled-button" data-mission="Derelict Wreck">Accept Mission</button>
    </div>
  </div>

  <div class="large-content-card" data-mission-type="exploration">
    <div class="card-header-icon">
      <img src="./Images/Patches/Exploration.png" alt="Exploration Icon" class="card-large-icon" />
      <h2>Unknown Planet Scan</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 60.000 UEC</p>
      <p class="card-main-text">Explore and scan the surface of an uncharted planet.</p>
      <button class="accept-mission styled-button" data-mission="Unknown Planet Scan">Accept Mission</button>
    </div>
  </div>

</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const CSV_DATA_URL = 'https://docs.google.com/spreadsheets/d/11Z1mGOzrpVnKhNV-hnOIJmrWAGl5DeGLnEn5gMlsriE/export?format=csv&gid=0';
  const webhookURL = 'https://hook.eu2.make.com/y25idqg0rqvbj73jyt4udw7o71kal1b4';
  const REDIRECT_URL = 'https://erasmusdev.github.io/Vortex-Protocol';
  const USER_NAME_KEY = 'PlayerInGameName';

  const saveBtn = document.getElementById('savePlayer');
  const playerNameInput = document.getElementById('playerNameInput');
  const missionSection = document.getElementById('mission-section');
  const playerSetupSectionWrapper = document.getElementById('player-setup-section-wrapper');
  const missionFilter = document.getElementById('missionTypeFilter');

  async function applyGlobalStatus() {
    const missionStatusMap = {};
    const CSV_SPLIT_REGEX = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
    try {
      const response = await fetch(CSV_DATA_URL);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const csvText = await response.text();
      const lines = csvText.trim().split('\n');
      if (lines.length <= 1) return;
      const cleanField = field => field.replace(/^"|"$/g, '').trim();
      const headers = lines[0].split(CSV_SPLIT_REGEX).map(cleanField);
      const missionIdIndex = headers.indexOf('Bounty_ID');
      const statusIndex = headers.indexOf('Status');
      if (missionIdIndex === -1 || statusIndex === -1) return;
      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(CSV_SPLIT_REGEX);
        if (columns.length <= Math.max(missionIdIndex, statusIndex)) continue;
        const missionId = cleanField(columns[missionIdIndex]);
        const status = cleanField(columns[statusIndex]).toUpperCase();
        if (missionId) missionStatusMap[missionId] = status;
      }
    } catch (err) {
      console.error('Failed to fetch mission data', err);
      return;
    }

    document.querySelectorAll('.large-content-card').forEach(card => {
      const missionName = card.querySelector('h2').textContent.trim();
      const btn = card.querySelector('.accept-mission');
      if (!btn) return;
      const status = missionStatusMap[missionName] || 'NEW';
      if (status === 'ACCEPTED') {
        btn.disabled = true;
        btn.textContent = "ACCEPTED";
        btn.classList.add('accepted-mission-btn');
      } else if (['COMPLETED','CANCELLED','FAILED'].includes(status)) {
        card.style.display = 'none';
      } else {
        btn.disabled = false;
        btn.textContent = "Accept Mission";
        btn.classList.remove('accepted-mission-btn');
        card.style.display = 'block';
      }
    });
  }

  async function initializeMissionBoard() {
    await applyGlobalStatus();
    const storedPlayerName = sessionStorage.getItem(USER_NAME_KEY);
    if (storedPlayerName) {
      playerSetupSectionWrapper.style.display = 'none';
      missionSection.style.display = 'block';
    } else {
      playerSetupSectionWrapper.style.display = 'block';
      missionSection.style.display = 'none';
    }
  }

  initializeMissionBoard();

  saveBtn.addEventListener('click', () => {
    const playerName = playerNameInput.value.trim();
    if (!playerName) return alert("Your In-Game Name is required for Secure Access.");
    sessionStorage.setItem(USER_NAME_KEY, playerName);
    playerSetupSectionWrapper.style.display = 'none';
    missionSection.style.display = 'block';
  });

  missionFilter.addEventListener('change', () => {
    const selectedType = missionFilter.value;
    document.querySelectorAll('.large-content-card').forEach(card => {
      if (selectedType === 'all' || card.dataset.missionType === selectedType) {
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    });
  });

  document.querySelectorAll('.accept-mission').forEach(btn => {
    btn.addEventListener('click', async () => {
      const missionName = btn.dataset.mission;
      const missionType = btn.closest('.large-content-card').dataset.missionType;
      const playerName = sessionStorage.getItem(USER_NAME_KEY);

      if (!playerName) {
        alert("Session expired. Please re-enter your In-Game Name.");
        playerSetupSectionWrapper.style.display = 'block';
        missionSection.style.display = 'none';
        return;
      }
      if (btn.disabled) return alert(`Mission "${missionName}" is already accepted!`);

      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = "SENDING SIGNAL...";
      btn.classList.add('sending-mission-btn');

      const payload = {
        mission: missionName,
        type: missionType,
        player: playerName,
        timestamp: new Date().toISOString(),
        status: "ACCEPTED"
      };

      try {
        const response = await fetch(webhookURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const resultText = await response.text();
        let parsed = null;
        try { parsed = JSON.parse(resultText); } catch(e){}

        const denied = !response.ok || 
          (parsed && (parsed.success === false || parsed.allowed === false || parsed.whitelisted === false)) ||
          (/denied|unauthor|forbidden/i.test(resultText));

        if (denied) {
          alert("ACCESS DENIED â€” You are not on the whitelist.");
          sessionStorage.removeItem(USER_NAME_KEY);
          window.location.href = REDIRECT_URL;
          return;
        }

        btn.textContent = "ACCEPTED (Awaiting Global Status)";
        btn.classList.remove('sending-mission-btn');
        btn.classList.add('accepted-mission-btn');
        setTimeout(initializeMissionBoard, 4000);
        alert(`Mission "${missionName}" accepted!`);
      } catch(err) {
        console.error(err);
        btn.disabled = false;
        btn.textContent = prevText || "Accept Mission";
        btn.classList.remove('sending-mission-btn');
        btn.classList.remove('accepted-mission-btn');
        alert("Error communicating with server. Please try again.");
      }
    });
  });
});
</script>
</body>
</html>
