<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bounty Board</title>
  <link rel="stylesheet" href="./CSS/bountyboard.css" />
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet" />
</head>
<body>
<header class="navbar">
  <div class="navbar-left">
    <a href="index.html" class="logo">VORTEX BOUNTIES</a>
    <nav>
      <ul>
        <li><a href="index.html">HOME</a></li>
        <li><a href="#">INDUSTRIAL</a></li>
        <li><a href="#">LOGISTICS</a></li>
        <li><a href="#">SCIENCE</a></li>
        <li><a href="#">DEFENSE</a></li>
      </ul>
    </nav>
  </div>
  <div class="navbar-right">
    <a href="https://discord.gg/DuWnazV4" class="icon-link"><img src="./Images/Discord.png" alt="Discord Icon"><span>DISCORD</span></a>
    <a href="#" class="icon-link"><img src="./Images/Youtube.png" alt="YouTube Icon"><span>YOUTUBE</span></a>
    <a href="https://www.twitch.tv/flockersdesign" class="icon-link"><img src="./Images/Twitch.png" alt="Twitch Icon"><span>TWITCH</span></a>
  </div>
</header>

<section class="player-setup-section" id="player-setup-section-wrapper">
  <div id="player-setup" class="setup-container">
    <h2 class="setup-title">IDENTIFY YOURSELF, PILOT (IN-GAME NAME)</h2>
    <div class="input-group">
      <input type="text" id="playerNameInput" placeholder="Enter your In-Game Name..." class="styled-input" />
      <button id="savePlayer" class="styled-button">Secure Access</button>
    </div>
  </div>
</section>

<section id="bounty-section" style="display:none; padding:20px;">
  <h2 class="section-protocol-title">AVAILABLE BOUNTIES</h2>

  <div class="large-content-card industrial">
    <div class="card-header-icon">
      <img src="./Images/Patches/Mining-Operation.png" alt="Bounty Icon" class="card-large-icon" />
      <h2>Gendo_dk</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 100.000 UEC</p>
      <p class="card-main-text">This user has killed multiple from our Org so now has a bounty. Target is active in the asteroid belt of Yela.</p>
      <button class="accept-bounty styled-button" data-bounty="Gendo_dk">Accept Bounty</button>
    </div>
  </div>

  <div class="large-content-card logistics">
    <div class="card-header-icon">
      <img src="./Images/Patches/Salvage-recovery.png" alt="Bounty Icon" class="card-large-icon" />
      <h2>Starfire_X</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 50.00 UEC</p>
      <p class="card-main-text">Caught raiding our supply routes multiple times. Last seen near Port Olisar.</p>
      <button class="accept-bounty styled-button" data-bounty="Starfire_X">Accept Bounty</button>
    </div>
  </div>

  <div class="large-content-card defense">
    <div class="card-header-icon">
      <img src="./Images/Patches/Salvage-recovery.png" alt="Bounty Icon" class="card-large-icon" />
      <h2>MrViking</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 1.000.000 UEC</p>
      <p class="card-main-text">High-value target. Caught raiding our supply routes multiple times. Current location unknown (RISK: HIGH).</p>
      <button class="accept-bounty styled-button" data-bounty="MrViking">Accept Bounty</button>
    </div>
  </div>

  <div class="large-content-card defense">
    <div class="card-header-icon">
      <img src="./Images/Patches/Salvage-recovery.png" alt="Bounty Icon" class="card-large-icon" />
      <h2>Granden</h2>
    </div>
    <div class="card-body">
      <p class="card-tagline">Reward: 1.500.000 UEC</p>
      <p class="card-main-text">High-value target. Caught raiding our supply routes multiple times. Current location unknown (RISK: HIGH).</p>
      <button class="accept-bounty styled-button" data-bounty="Granden">Accept Bounty</button>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const CSV_DATA_URL = 'https://docs.google.com/spreadsheets/d/11Z1mGOzrpVnKhNV-hnOIJmrWAGl5DeGLnEn5gMlsriE/export?format=csv&gid=0';
  const webhookURL = 'https://hook.eu2.make.com/y25idqg0rqvbj73jyt4udw7o71kal1b4';
  const REDIRECT_URL = 'https://erasmusdev.github.io/Vortex-Protocol';
  const USER_NAME_KEY = 'PlayerInGameName';

  const saveBtn = document.getElementById('savePlayer');
  const playerNameInput = document.getElementById('playerNameInput');
  const bountySection = document.getElementById('bounty-section');
  const playerSetupSectionWrapper = document.getElementById('player-setup-section-wrapper');

  async function applyGlobalStatus() {
    const bountyStatusMap = {};
    const CSV_SPLIT_REGEX = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
    try {
      const response = await fetch(CSV_DATA_URL);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const csvText = await response.text();
      const lines = csvText.trim().split('\n');
      if (lines.length <= 1) return;
      const cleanField = field => field.replace(/^"|"$/g, '').trim();
      const headers = lines[0].split(CSV_SPLIT_REGEX).map(cleanField);
      const bountyIdIndex = headers.indexOf('Bounty_ID');
      const statusIndex = headers.indexOf('Status');
      if (bountyIdIndex === -1 || statusIndex === -1) return;
      for (let i = 1; i < lines.length; i++) {
        const columns = lines[i].split(CSV_SPLIT_REGEX);
        if (columns.length <= Math.max(bountyIdIndex, statusIndex)) continue;
        const bountyId = cleanField(columns[bountyIdIndex]);
        const status = cleanField(columns[statusIndex]).toUpperCase();
        if (bountyId) bountyStatusMap[bountyId] = status;
      }
    } catch (err) {
      console.error('Failed to fetch bounty data', err);
      return;
    }

    document.querySelectorAll('.large-content-card').forEach(card => {
      const targetPlayerId = card.querySelector('h2').textContent.trim();
      const btn = card.querySelector('.accept-bounty');
      if (!btn) return;
      const status = bountyStatusMap[targetPlayerId] || 'NEW';
      if (status === 'ACCEPTED') {
        btn.disabled = true;
        btn.textContent = "ACCEPTED";
        btn.classList.add('accepted-bounty-btn');
      } else if (['COMPLETED','CANCELLED','FAILED'].includes(status)) {
        card.style.display = 'none';
      } else {
        btn.disabled = false;
        btn.textContent = "Accept Bounty";
        btn.classList.remove('accepted-bounty-btn');
        card.style.display = 'block';
      }
    });
  }

  async function initializeBountyBoard() {
    await applyGlobalStatus();
    const storedPlayerName = sessionStorage.getItem(USER_NAME_KEY);
    if (storedPlayerName) {
      playerSetupSectionWrapper.style.display = 'none';
      bountySection.style.display = 'block';
    } else {
      playerSetupSectionWrapper.style.display = 'block';
      bountySection.style.display = 'none';
    }
  }
  initializeBountyBoard();

  saveBtn.addEventListener('click', () => {
    const playerName = playerNameInput.value.trim();
    if (!playerName) return alert("Your In-Game Name is required for Secure Access.");
    sessionStorage.setItem(USER_NAME_KEY, playerName);
    playerSetupSectionWrapper.style.display = 'none';
    bountySection.style.display = 'block';
  });

  // Helper that evaluates webhook response to determine if it's a DENY
  function isDeniedResponse(response, bodyText, parsedJson) {
    // 1) non-OK HTTP status
    if (!response.ok && response.status !== 200) return true;

    // 2) JSON fields that indicate failure
    if (parsedJson) {
      // common patterns: { success: false }, { allowed: false }, { whitelisted: false }, { error: "..."}
      if (parsedJson.success === false) return true;
      if (parsedJson.allowed === false) return true;
      if (parsedJson.whitelisted === false) return true;
      if (typeof parsedJson.error === 'string' && parsedJson.error.length) return true;
      if (typeof parsedJson.message === 'string' && /denied|not whitelisted|unauthor/i.test(parsedJson.message)) return true;
      if (typeof parsedJson.status === 'string' && /denied|unauthor|forbidden/i.test(parsedJson.status)) return true;
    }

    // 3) fallback: raw text keyword checks
    if (typeof bodyText === 'string') {
      if (/denied|not whitelisted|not authorized|unauthorized|forbidden|access denied|not allowed/i.test(bodyText)) return true;
      // some flows return plain "false" or "0" - treat them as denies
      if (/^\s*(false|0)\s*$/i.test(bodyText)) return true;
    }

    // otherwise, treat as allowed
    return false;
  }

  document.querySelectorAll('.accept-bounty').forEach(btn => {
    btn.addEventListener('click', async () => {
      const acceptingPlayerName = sessionStorage.getItem(USER_NAME_KEY);
      const targetCard = btn.closest('.large-content-card');
      const targetPlayer = targetCard.querySelector('h2').textContent.trim();
      const rewardText = targetCard.querySelector('.card-tagline')?.textContent.replace('Reward: ', '').trim() || 'N/A';

      if (!acceptingPlayerName) {
        alert("Session expired. Please re-enter your In-Game Name, pilot.");
        playerSetupSectionWrapper.style.display = 'block';
        bountySection.style.display = 'none';
        return;
      }
      if (btn.disabled) return alert(`Bounty "${targetPlayer}" is already accepted!`);

      // set a neutral "sending" state (don't show accepted yet)
      btn.disabled = true;
      const prevText = btn.textContent;
      btn.textContent = "SENDING SIGNAL...";
      btn.classList.add('sending-bounty-btn');

      const payload = {
        bounty: targetPlayer,
        player: acceptingPlayerName,
        reward: rewardText,
        timestamp: new Date().toISOString(),
        status: "ACCEPTED",
        UserwhitelistId: acceptingPlayerName
      };

      try {
        const response = await fetch(webhookURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // read text and try parse JSON
        const resultText = await response.text();
        console.log("Webhook status:", response.status);
        console.log("Webhook body:", resultText);

        let parsed = null;
        try {
          parsed = JSON.parse(resultText);
        } catch (e) {
          // not JSON, that's fine
        }

        // robust denial detection
        if (isDeniedResponse(response, resultText, parsed)) {
          // Access denied -> revert UI, clear session, redirect
          alert("ACCESS DENIED — You are not on the whitelist.");
          sessionStorage.removeItem(USER_NAME_KEY);
          // optional: small delay so user sees the alert before redirecting
          window.location.href = REDIRECT_URL;
          return;
        }

        // Success path: mark accepted and refresh status
        btn.textContent = "ACCEPTED (Awaiting Global Status)";
        btn.classList.remove('sending-bounty-btn');
        btn.classList.add('accepted-bounty-btn');
        // optionally keep disabled; global status will update soon
        setTimeout(initializeBountyBoard, 4000);
        alert(`Bounty "${targetPlayer}" accepted!`);

      } catch (err) {
        console.error("Webhook error:", err);
        alert("Error communicating with server. Please try again.");
        // revert UI
        btn.disabled = false;
        btn.textContent = prevText || "Accept Bounty";
        btn.classList.remove('sending-bounty-btn');
        btn.classList.remove('accepted-bounty-btn');
      }
    });
  });
});
</script>
</body>
</html>
