<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bounty Board</title>
    <link rel="stylesheet" href="./CSS/bountyboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>
<body>

<header class="navbar">
    <div class="navbar-left">
        <a href="index.html" class="logo">VORTEX BOUNTIES</a>
        <nav>
            <ul>
                <li><a href="index.html">HOME</a></li>
                <li><a href="#">INDUSTRIAL</a></li>
                <li><a href="#">LOGISTICS</a></li>
                <li><a href="#">SCIENCE</a></li>
                <li><a href="#">DEFENSE</a></li>
            </ul>
        </nav>
    </div>
    <div class="navbar-right">
        <a href="https://discord.gg/DuWnazV4" class="icon-link"><img src="./Images/Discord.png" alt="Discord Icon"><span>DISCORD</span></a>
        <a href="#" class="icon-link"><img src="./Images/Youtube.png" alt="YouTube Icon"><span>YOUTUBE</span></a>
        <a href="https://www.twitch.tv/flockersdesign" class="icon-link"><img src="./Images/Twitch.png" alt="Twitch Icon"><span>TWITCH</span></a>
    </div>
</header>

<section class="player-setup-section">
    <div id="player-setup" class="setup-container">
        <h2 class="setup-title">IDENTIFY YOURSELF, PILOT</h2>
        <div class="input-group">
            <input type="text" id="playerName" placeholder="Enter your in-game handle..." class="styled-input">
            <button id="savePlayer" class="styled-button">Secure Access</button>
        </div>
    </div>
</section>

<section id="bounty-section" style="display:none; padding: 20px;">
    <h2 class="section-protocol-title">AVAILABLE BOUNTIES</h2>

    <div class="large-content-card industrial">
        <div class="card-header-icon">
            <img src="./Images/Patches/Mining-Operation.png" alt="Bounty Icon" class="card-large-icon">
            <h2>Gendo_dk</h2> 
        </div>
        <div class="card-body">
            <p class="card-tagline">Reward: 100.000 UEC</p>
            <p class="card-main-text">This user has killed multiple from our Org so now has a bounty. Target is active in the asteroid belt of Yela.</p>
            <button class="accept-bounty styled-button" data-bounty="Gendo_dk">Accept Bounty</button>
        </div>
    </div>

    <div class="large-content-card logistics">
        <div class="card-header-icon">
            <img src="./Images/Patches/Salvage-recovery.png" alt="Bounty Icon" class="card-large-icon">
            <h2>Starfire_X</h2>
        </div>
        <div class="card-body">
            <p class="card-tagline">Reward: 50.00 UEC</p>
            <p class="card-main-text">Caught raiding our supply routes multiple times. Last seen near Port Olisar.</p>
            <button class="accept-bounty styled-button" data-bounty="Starfire_X">Accept Bounty</button>
        </div>
    </div>

    <div class="large-content-card defense">
        <div class="card-header-icon">
            <img src="./Images/Patches/Salvage-recovery.png" alt="Bounty Icon" class="card-large-icon">
            <h2>MrViking</h2>
        </div>
        <div class="card-body">
            <p class="card-tagline">Reward: 1.000.000 UEC</p>
            <p class="card-main-text">High-value target. Caught raiding our supply routes multiple times. Current location unknown (RISK: HIGH).</p>
            <button class="accept-bounty styled-button" data-bounty="MrViking">Accept Bounty</button>
        </div>
    </div>

    <div class="large-content-card defense">
        <div class="card-header-icon">
            <img src="./Images/Patches/Salvage-recovery.png" alt="Bounty Icon" class="card-large-icon">
            <h2>Granden</h2>
        </div>
        <div class="card-body">
            <p class="card-tagline">Reward: 1.500.000 UEC</p>
            <p class="card-main-text">High-value target. Caught raiding our supply routes multiple times. Current location unknown (RISK: HIGH).</p>
            <button class="accept-bounty styled-button" data-bounty="Granden">Accept Bounty</button>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', (event) => {
    // --- ELEMENT REFERENCES ---
    const saveBtn = document.getElementById('savePlayer');
    const playerInput = document.getElementById('playerName');
    const bountySection = document.getElementById('bounty-section');
    const playerSetupElement = document.getElementById('player-setup');
    const playerSetupSectionWrapper = document.getElementById('player-setup-section-wrapper'); 
    const acceptedBountiesKey = 'acceptedBounties'; 

    // ----------------------------------------------------
    // 2. CHECK AND APPLY ACCEPTED STATUS TO BOUNTIES
    // ----------------------------------------------------
    function applyAcceptedStatus() {
        const acceptedBounties = JSON.parse(localStorage.getItem(acceptedBountiesKey) || '{}');

        document.querySelectorAll('.accept-bounty').forEach(btn => {
            const targetPlayerId = btn.dataset.bounty;
            
            // If this bounty ID exists in our local storage record, disable the button
            if (acceptedBounties[targetPlayerId]) {
                btn.disabled = true;
                btn.textContent = "ACCEPTED";
            } else {
                // Ensure buttons that are not accepted are re-enabled
                btn.disabled = false;
                btn.textContent = "Accept Bounty"; 
            }
        });
    }

    // ----------------------------------------------------
    // 1. INITIAL PAGE LOAD LOGIC (Visibility and Status)
    // ----------------------------------------------------
    const storedName = localStorage.getItem('playerName');

    if (storedName) {
        playerSetupSectionWrapper.style.display = 'none'; 
        bountySection.style.display = 'block';
        applyAcceptedStatus(); // Run status check immediately
    } else {
        playerSetupSectionWrapper.style.display = 'block';
        bountySection.style.display = 'none';
    }


    // --- SAVE BUTTON LISTENER ---
    saveBtn.addEventListener('click', () => {
        const playerName = playerInput.value.trim();
        if(!playerName) return alert("Enter a player name!");
        
        localStorage.setItem('playerName', playerName);
        
        playerSetupSectionWrapper.style.display = 'none'; 
        bountySection.style.display = 'block';

        applyAcceptedStatus(); 
    });


    // --- MAKE WEBHOOK POST ---
    const webhookURL = 'https://hook.eu2.make.com/y25idqg0rqvbj73jyt4udw7o71kal1b4'; 

    document.querySelectorAll('.accept-bounty').forEach(btn => {
        btn.addEventListener('click', async () => {
            const acceptingPlayer = localStorage.getItem('playerName'); 
            const targetPlayer = btn.dataset.bounty; 

            if(!acceptingPlayer) return alert("No player name set!");

            // Check immediately if this bounty is already accepted BEFORE sending webhook
            const acceptedBounties = JSON.parse(localStorage.getItem(acceptedBountiesKey) || '{}');
            if (acceptedBounties[targetPlayer]) {
                 alert(`Bounty "${targetPlayer}" has already been accepted!`);
                 btn.disabled = true; // Safety check
                 btn.textContent = "ACCEPTED";
                 return; // STOP EXECUTION
            }
            
            const targetCard = btn.closest('.large-content-card'); 
            const rewardElement = targetCard.querySelector('.card-tagline');
            const rewardText = rewardElement ? rewardElement.textContent.replace('Reward: ', '').trim() : 'N/A';

            // Disable button while waiting for webhook response
            btn.disabled = true;

            const payload = {
                acceptingPlayer: acceptingPlayer,
                targetPlayer: targetPlayer,
                reward: rewardText,
                timestamp: new Date().toISOString()
            };

            try {
                const response = await fetch(webhookURL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });

                if(response.ok){
                    alert(`Bounty "${targetPlayer}" accepted! Reward: ${rewardText}`);
                    
                    // *** PERSIST THE ACCEPTED STATUS IN LOCAL STORAGE ***
                    let updatedBounties = JSON.parse(localStorage.getItem(acceptedBountiesKey) || '{}');
                    updatedBounties[targetPlayer] = acceptingPlayer;
                    localStorage.setItem(acceptedBountiesKey, JSON.stringify(updatedBounties));
                    
                    // Final UI update
                    btn.textContent = "ACCEPTED"; 

                } else {
                    console.error("Webhook POST failed", response.status, response.statusText);
                    alert("Failed to accept bounty. Check console for errors.");
                    btn.disabled = false; // Re-enable button on failure
                }
            } catch(err){
                console.error(err);
                alert("Error sending webhook. Check console for details.");
                btn.disabled = false; // Re-enable button on error
            }
        });
    });
});
</script>

</body>
</html>